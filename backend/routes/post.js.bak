const router = require("express").Router();
const authMiddleware = require("../middleware/authMiddleware");
const multer = require("multer");
const path = require("path");
const fs = require("fs");
const postCtrl = require("../controllers/postController");

const uploadDir = "uploads";
if (!fs.existsSync(uploadDir)) fs.mkdirSync(uploadDir);

const storage = multer.diskStorage({
  destination: (req, file, cb) => cb(null, uploadDir + "/"),
  filename: (req, file, cb) => {
    const ext = path.extname(file.originalname);
    const name = Date.now() + "-" + Math.round(Math.random() * 1e9);
    cb(null, name + ext);
  }
});

function fileFilter(req, file, cb) {
  const mime = file.mimetype.toLowerCase();
  if (mime.startsWith("image")) return cb(null, true);
  if (mime.startsWith("video")) return cb(null, true);
  if (mime.startsWith("audio")) return cb(null, true);
  if (mime === "application/pdf") return cb(null, true);
  return cb(new Error("Format non support√©"), false);
}
}

const upload = multer({
  storage,
  limits: { fileSize: 100 * 1024 * 1024 },
  fileFilter,
});

router.post("/", authMiddleware, upload.array("files", 10), postCtrl.create);
router.get("/", authMiddleware, postCtrl.list);
router.post("/:id/like", authMiddleware, postCtrl.like);
router.post("/:id/comment", authMiddleware, postCtrl.comment);
router.post("/:id/comment/:commentId/reply", authMiddleware, postCtrl.reply);
router.delete("/:id", authMiddleware, postCtrl.delete);

module.exports = router;
